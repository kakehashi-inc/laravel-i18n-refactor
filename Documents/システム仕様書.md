# Laravel多言語化支援ツール - 要件定義・仕様書

## 1. プログラムの目的

Laravelプロジェクト内でハードコードされた文字列を検出し、多言語化対応（langファイルへの切り出し）を支援するためのツール。

**背景：**
- Bladeテンプレート内に直接記載されたテキスト
- Controller/Service等のPHPファイル内の文字列リテラル（バリデーションメッセージ等）
- これらを効率的に抽出し、同一文字列を統合管理する必要がある

---

## 2. 機能概要

1. 指定ディレクトリ配下のファイルを再帰的に探索
2. 2種類の処理方式でハードコード文字列を抽出
3. 同一文字列を統合し、出現箇所を集約
4. JSON形式で結果を出力

---

## 3. コマンドライン引数仕様

**構文：**
```bash
python extract_strings.py <directory> [OPTIONS]
```

**引数：**
| 引数 | 短縮形 | 必須 | デフォルト値 | 説明 |
|------|--------|------|--------------|------|
| directory | - | ○ | - | 探索対象ディレクトリパス（位置引数） |
| --name | -n | × | `**/*.php` | 探索パターン（ワイルドカード対応） |
| --output | -o | × | 標準出力 | 出力JSONファイル名 |

**使用例：**
```bash
# デフォルト（全phpファイル）
python extract_strings.py .

# カスタムパターン
python extract_strings.py resources/views -n "**/*.blade.php" -o result.json

# 特定ディレクトリのみ
python extract_strings.py app/Services -n "*.php" -o output.json
```

---

## 4. 処理対象ファイルと処理方式

**ファイルタイプ判別：**
拡張子により処理方式を自動振り分け

| ファイル拡張子 | 処理方式 |
|---------------|---------|
| `.blade.php` | Blade処理（HTML解析） |
| `.php`（上記以外） | PHP文字列リテラル処理 |

---

## 5. Bladeファイルの処理ロジック

**5.1 抽出対象**

ハードコードされた全てのテキストリテラル：
- HTMLタグ間のテキストノード全体
- HTML属性値全体
- `<script>`タグ内のJavaScript文字列リテラル

**重要：**
- テキストノードや属性値は**全体を1つの文字列**として扱う
- 単語単位での分割は行わない
- スペース、タブ、改行コードをそのまま保持
- 言語の種類は問わない（日本語、英語、数字、記号の混在も全て対象）

**5.2 除外対象**

**5.2.1 コメント（内容を含め全て無視）**
- HTMLコメント：`<!-- ... -->`
- Bladeコメント：`{{-- ... --}}`

**5.2.2 Blade構文（既に多言語対応済み）**
- 翻訳関数：
  - `{{ __('key') }}`
  - `{{ trans('key') }}`
  - `{!! __('key') !!}`
  - `{!! trans('key') !!}`
  - `@lang('key')`
- PHP変数展開：
  - `{{ $variable }}`
  - `{!! $variable !!}`
- PHP構文ブロック：
  - `<?php ... ?>`
  - `@php ... @endphp`
- Bladeディレクティブ内の式：
  - `@if($condition)`
  - `@foreach($items as $item)`
  - その他全てのディレクティブの引数部分

**5.2.3 除外する文字列**
- 空文字列
- 空白のみの文字列（スペース、タブ、改行のみで構成）

**5.3 抽出例**

```html
<!-- 抽出対象 -->
<p>こんにちは、Worldへようこそ。123</p>
<!-- → "こんにちは、Worldへようこそ。123" -->

<h1>Laravel Framework による開発</h1>
<!-- → "Laravel Framework による開発" -->

<div>2024年11月6日
の記録</div>
<!-- → "2024年11月6日\nの記録" -->

<input placeholder="お名前を入力">
<!-- → "お名前を入力" -->

<button title="Click here">送信</button>
<!-- → "Click here" と "送信" の2つ -->

<!-- 除外対象 -->
{{ __('messages.welcome') }}
<!-- 翻訳関数内 -->

{{ $userName }}
<!-- 変数展開 -->

<!-- <p>コメント内のテキスト</p> -->
<!-- HTMLコメント -->

{{-- Bladeコメント --}}
<!-- Bladeコメント -->
```

---

## 6. PHPファイルの処理ロジック

**6.1 処理ステップ**

1. 全コメントの除外（コメント内の文字列リテラルも全て無視）
2. 文字列リテラル（`'...'`, `"..."`）の全抽出（位置情報・長さを記録）
3. 各文字列の前後コンテキストを解析
4. 除外パターンに該当しない文字列のみを結果に含める

**6.2 除外対象**

**6.2.1 コメント（内容を含め全て無視）**
- 単行コメント：`// ...`、`# ...`
- 複数行コメント：`/* ... */`
- PHPDocコメント：`/** ... */`

**6.2.2 前後コンテキストによる除外パターン**

| カテゴリ | 除外パターン |
|---------|------------|
| 翻訳関数 | `__()`, `trans()`, `@lang()`, `Lang::get()` |
| ログ出力 | `Log::info()`, `Log::error()`, `Log::warning()`, `Log::*()`, `logger()`, `error_log()` |
| コンソール出力 | `echo`, `print`, `var_dump()`, `dd()`, `dump()`, `print_r()` |
| バッチ処理出力 | `$this->info()`, `$this->error()`, `$this->line()`, `$this->comment()`, `$this->warn()` |
| 配列キー | `'key' =>`, `["key" =>]` |
| PHP構文要素 | `use`, `namespace`, クラス名、`const`定義名、関数名定義 |

**6.3 抽出対象**

除外パターンに該当しない全ての文字列リテラル：
- バリデーションメッセージ
- エラーメッセージ、成功メッセージ
- 例外メッセージ
- レスポンスメッセージ
- その他ユーザーに表示される文字列
- 言語の種類は問わない

**6.4 抽出・除外の具体例**

```php
// 【抽出対象】
'required' => '必須項目です',
throw new Exception('データが見つかりません');
return response()->json(['error' => 'エラーが発生しました']);
$message = '登録が完了しました';

// 【除外対象】
// $message = 'コメント内';  // コメント
__('messages.welcome')  // 翻訳関数
Log::info('処理開始');  // ログ
echo 'テスト';  // コンソール出力
$this->info('完了');  // バッチ出力
'name' => '太郎',  // 'name'は除外、'太郎'は抽出
```

**6.5 文字列の扱い**
- エスケープシーケンス（`\n`, `\t`, `\'`, `\"`等）をそのまま保持
- 複数行文字列（ヒアドキュメント、Nowdoc）も対象
- 空文字列、空白のみの文字列は除外

---

## 7. 出力形式

**7.1 JSON構造**

```json
[
  {
    "text": "抽出された文字列内容",
    "occurrences": [
      {
        "file": "resources/views/example.blade.php",
        "positions": [
          {
            "line": 10,
            "column": 5,
            "length": 25
          },
          {
            "line": 15,
            "column": 8,
            "length": 25
          }
        ]
      },
      {
        "file": "app/Http/Controllers/UserController.php",
        "positions": [
          {
            "line": 45,
            "column": 20,
            "length": 25
          }
        ]
      }
    ]
  },
  {
    "text": "別の文字列\n改行を含む",
    "occurrences": [
      {
        "file": "resources/views/admin/index.blade.php",
        "positions": [
          {
            "line": 5,
            "column": 12,
            "length": 17
          }
        ]
      }
    ]
  }
]
```

**7.2 データ構造の説明**

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `text` | string | 抽出された文字列内容（改行・タブ・スペース・エスケープシーケンスを保持） |
| `occurrences` | array | 出現箇所の配列 |
| `occurrences[].file` | string | ファイルパス（探索ディレクトリからの相対パス） |
| `occurrences[].positions` | array | 同一ファイル内の出現位置配列 |
| `positions[].line` | integer | 行番号（1始まり） |
| `positions[].column` | integer | カラム番号（0始まり） |
| `positions[].length` | integer | 文字列の長さ（文字数） |

**7.3 統合ルール**
- 同一文字列（`text`が完全一致）は1エントリに統合
- 同一ファイル内の複数出現箇所は`positions`配列にまとめる
- 異なるファイルは`occurrences`配列に別エントリとして追加

---

## 8. 技術要件

**8.1 開発言語**
- Python 3.7以上

**8.2 依存ライブラリ**
- 標準ライブラリ：`argparse`, `pathlib`, `json`, `re`
- 外部ライブラリ（推奨）：`beautifulsoup4`, `lxml`

**8.3 処理の安全性**

**Bladeファイル：**
1. コメントを除去
2. Blade構文を検出・マスク
3. 残ったHTMLからテキストノード・属性値を抽出
4. マスク位置と重複しない文字列のみを対象

**PHPファイル：**
1. 全コメントを除去
2. 文字列リテラル（`'...'`, `"..."`）を全抽出
3. 各文字列の前後コンテキストを解析
4. 除外パターンに該当しない文字列のみを結果に含める

---

## 9. 制約事項

**9.1 JSON出力**
- JSON属性名に制御コードを含めない
- 改行・タブ・特殊文字は適切にエスケープ

**9.2 文字列の扱い**
- 改行コード（`\n`）、タブ（`\t`）、スペースはそのまま保持
- 空文字列、空白のみの文字列は除外
- エスケープシーケンスを正しく解釈

**9.3 処理対象外**
- 動的に生成される文字列（変数連結等）
- 複雑にネストしたBlade構文の一部
